function wikibar_install(){config.commands.wikibar={text:"wikibar",tooltip:"wikibar on/off",handler:function(e,t,n){if(!e){e=window.event}n=n.replace(/_/g,"__").replace(/ /g,"_");var r=resolveTarget(e);r.id="wikibarButton"+n;wikibarPopup.remove();wikibar_installAddons(r,n);wikibar_createWikibar(n);return false}};config.shadowTiddlers["EditTemplate"]=wikibar_addWikibarCommand(config.shadowTiddlers["EditTemplate"]);var e=store.getTiddler("EditTemplate");if(e){e.text=wikibar_addWikibarCommand(e.text)}}function wikibar_installAddons(theButton,title){var tiddlers=store.getTaggedTiddlers("wikibarAddons");if(!tiddlers){return}theButton.addons=[];for(var i=0;i<tiddlers.length;i++){try{eval(tiddlers[i].text);try{wikibar_addonInstall(title);wikibar_addonInstall=null;theButton.addons.push({ok:true,name:tiddlers[i].title})}catch(ex){theButton.addons.push({ok:false,name:tiddlers[i].title,error:ex})}}catch(ex){theButton.addons.push({ok:false,name:tiddlers[i].title,error:ex})}}}function wikibar_addWikibarCommand(e){var t=document.createElement("div");t.style.display="none";t.innerHTML=e;for(var n=0;n<t.childNodes.length;n++){var r=t.childNodes[n];if(r.tagName==="DIV"){if(r.className=="toolbar"){var i=r.getAttribute("macro").trim();if(i.search("wikibar")<=0){i+=" wikibar";r.setAttribute("macro",i)}break}}}return t.innerHTML.replace(/\"/g,"'")}function wikibar_processSyntaxParams(e,t){try{var n="AplWikibarPcr";var r=null;var i=null;if(t){if(typeof t=="object"){for(var s=0;s<t.length;s++){if(t[s]){t[s]=t[s].replace(new RegExp("%","g"),n).trim();r="(\\[%"+(s+1)+"\\])"+"|"+"(%"+(s+1)+")";e=e.replace(new RegExp(r,"g"),t[s])}}i=t.join(" ").trim()}else{i=t.replace(new RegExp("%","g"),n).trim();r=/(\[%1{1}\])|(%1{1})/g;e=e.replace(r,i)}}if(i){e=e.replace(new RegExp("%N{1}","g"),i)}r=/\[%(([1-9]{1,}[0-9]{0,})|(N{1}))\]/g;e=e.replace(r,"");r=/%(([1-9]{1,}[0-9]{0,})|(N{1}))/g;if(e.match(r)){throw"Not enough parameters! "+e}e=e.replace(new RegExp(n,"g"),"%");return e}catch(o){return null}}function wikibar_resolveEditItem(e,t){if(e.hasChildNodes()){var n=e.childNodes;for(var r=0;r<n.length;r++){var i=wikibar_resolveEditItem(n[r],t);if(!i){continue}else{return i}}}return e.getAttribute&&e.getAttribute("edit")==t?e:null}function wikibar_resolveEditItemValue(e,t){var n=wikibar_resolveEditItem(e,t);return n?n.value.replace(/\r/mg,""):null}function wikibar_resolveTiddlerEditorWrapper(e){if(e.id=="tiddlerDisplay"){return null}if(e.getAttribute&&e.getAttribute("macro")=="edit text"){return e}return wikibar_resolveTiddlerEditorWrapper(e.parentNode)}function wikibar_resolveTiddlerEditor(e){if(e.hasChildNodes()){var t=e.childNodes;for(var n=0;n<t.length;n++){var r=wikibar_resolveTiddlerEditor(t[n]);if(r){return r}}}return e.getAttribute&&e.getAttribute("edit")=="text"?e:null}function wikibar_resolveTargetButton(e){if(e.id&&e.id.substring(0,7)=="wikibar"){return null}if(e.tiddlerTitle){return e}else{return wikibar_resolveTargetButton(e.parentNode)}}function wikibar_isValidMenuItem(e){if(!e){return false}if(e.TYPE=="MENU"||e.TYPE=="MAIN_MENU"){for(var t in e){if(t.substring(0,8)=="DYNAITEM"){return true}if(wikibar_isValidMenuItem(e[t])){return true}}return false}else{return e.HANDLER?true:false}}function wikibar_editFormat(e){var t=e.button.editor;var n=e.params;clearMessage();if(!t){return}var r=wikibar_processSyntaxParams(this.syntax,n);if(r===null){return}var i=t.scrollTop;var s=t.selectionStart;var o=t.selectionEnd;var u="";var a="";var f=t.value;if(o>s&&s>=0){u=f.substring(0,s);a=f.substring(o,f.length)}else if(s===0&&(o===0||o==f.length)){a=f}else if(o==s&&s>0){u=f.substring(0,s);a=f.substring(o,f.length)}if(r.indexOf("user_text")>=0&&this.hint){r=r.replace("user_text",this.hint)}t.value=u+r+a;t.selectionStart=s;t.selectionEnd=s+r.length;t.scrollTop=i;t.focus()}function wikibar_editFormatByWord(e){var t=e.button.editor;var n=e.params;clearMessage();if(!t){return}var r=wikibar_processSyntaxParams(this.syntax,n);if(r===null){return}var i=t.scrollTop;var s=t.selectionStart;var o=t.selectionEnd;var u="";var a="";var f="";var l=t.value;if(o>s&&s>=0){u=l.substring(0,s);a=l.substring(s,o);f=l.substring(o,l.length)}else if(s===0&&(o===0||o==l.length)){f=l}else if(o==s&&s>0){u=l.substring(0,s);f=l.substring(o,l.length);if(!(l.charAt(s-1).match(/\W/gi)||l.charAt(s).match(/\W/gi))){var c=u.match(/\W/gi);if(c){s=u.lastIndexOf(c[c.length-1])+1}else{s=0}c=f.match(/\W/gi);if(c){o+=f.indexOf(c[0])}else{o=l.length}u=l.substring(0,s);f=l.substring(o,l.length);a=l.substring(s,o)}}if(a.length>0){r=r.replace("user_text",a)}if(r.indexOf("user_text")>=0&&this.hint){r=r.replace("user_text",this.hint)}t.value=u+r+f;t.selectionStart=s;t.selectionEnd=s+r.length;t.scrollTop=i;t.focus()}function wikibar_editFormatByCursor(e){var t=e.button.editor;var n=e.params;clearMessage();if(!t){return}var r=wikibar_processSyntaxParams(this.syntax,n);if(r===null){return}var i=t.scrollTop;var s=t.selectionStart;var o=t.selectionEnd;var u="";var a="";var f=t.value;if(o>s&&s>=0){u=f.substring(0,s);a=f.substring(o,f.length)}else if(s===0&&(o===0||o==f.length)){a=f}else if(o==s&&s>0){u=f.substring(0,s);a=f.substring(o,f.length)}if(r.indexOf("user_text")>=0&&this.hint){r=r.replace("user_text",this.hint)}t.value=u+r+a;t.selectionStart=s;t.selectionEnd=s+r.length;t.scrollTop=i;t.focus()}function wikibar_editFormatByLine(e){var t=e.button.editor;var n=e.params;clearMessage();if(!t){return}var r=wikibar_processSyntaxParams(this.syntax,n);if(r===null){return}var i=t.scrollTop;var s=t.selectionStart;var o=t.selectionEnd;var u="";var a="";var f="";var l=t.value;if(o>s&&s>=0){if(this.byBlock){u=l.substring(0,s);a=l.substring(s,o);f=l.substring(o,l.length)}else{o=s}}if(s===0&&(o===0||o==l.length)){var c=l.match(/(\n|\r)/g);if(c){o=l.indexOf(c[0])}else{o=l.length}a=l.substring(0,o);f=l.substring(o,l.length)}else if(o==s&&s>0){u=l.substring(0,s);f=l.substring(o,l.length);c=u.match(/(\n|\r)/g);if(c){s=u.lastIndexOf(c[c.length-1])+1}else{s=0}c=f.match(/(\n|\r)/g);if(c){o+=f.indexOf(c[0])}else{o=l.length}u=l.substring(0,s);a=l.substring(s,o);f=l.substring(o,l.length)}if(a.length>0){r=r.replace("user_text",a)}if(r.indexOf("user_text")>=0&&this.hint){r=r.replace("user_text",this.hint)}if(this.byBlock){if(u.charAt(u.length-1)!="\n"&&s>0){r="\n"+r}if(f.charAt(0)!="\n"||o==l.length){r+="\n"}}t.value=u+r+f;t.selectionStart=s;t.selectionEnd=s+r.length;t.scrollTop=i;t.focus()}function wikibar_editFormatByTableCell(e){var t=e.button.editor;var n=e.params;clearMessage();if(!t){return}var r=wikibar_processSyntaxParams(this.syntax,n);if(r===null){return}var s=t.scrollTop;var o=t.selectionStart;var u=t.selectionEnd;var a="";var f="";var l="";var c=t.value;if(o===0||o==c.length){throw"not valid cell!"}u=o;a=c.substring(0,o);l=c.substring(u,c.length);i=a.lastIndexOf("\n");j=a.lastIndexOf("|");if(i>j||j<0){throw"not valid cell!"}o=j+1;i=l.indexOf("\n");j=l.indexOf("|");if(i<j||j<0){throw"not valid cell!"}u+=j;a=c.substring(0,o-1);f=c.substring(o,u);l=c.substring(u+1,c.length);if(this.key.substring(0,5)=="align"){f=f.trim();if(f==">"||f=="~"||f.substring(0,8)=="bgcolor("){return}}if(f.length>0){r=r.replace("user_text",f)}if(r.indexOf("user_text")>=0&&this.hint){r=r.replace("user_text",this.hint)}t.value=a+r+l;t.selectionStart=o;t.selectionEnd=o+r.length-2;t.scrollTop=s;t.focus()}function wikibar_editSelectAll(e){var t=e.button.editor;t.selectionStart=0;t.selectionEnd=t.value.length;t.scrollTop=0;t.focus()}function wikibar_doPreview(e){var t=e.button;var n=e.button.editor;var r=t.parentNode;if(!r){return}title=t.tiddlerTitle;var i=wikibar_resolveTiddlerEditorWrapper(n);var s=i.parentNode;var o=document.getElementById("previewer"+title);if(o){o.parentNode.removeChild(o);i.style.display="block";visible=true}else{o=document.createElement("div");o.id="previewer"+title;o.className="viewer previewer";o.style.height=n.offsetHeight+"px";wikify(n.value,o);s.insertBefore(o,i);i.style.display="none";visible=false}var u=null;for(var a=0;a<r.childNodes.length;a++){try{var f=r.childNodes[a];if(f.toolItem.key=="preview"){u=f}if(f.toolItem.key!="preview"){f.style.display=visible?"":"none"}}catch(l){}}if(!u){return}if(visible){u.innerHTML='<font face="verdana">&infin;</font>';u.title="preview current tiddler"}else{u.innerHTML='<font face="verdana">&larr;</font>';u.title="back to editor"}}function wikibar_doListAddons(e){clearMessage();var t=e.button.tiddlerTitle;var n=document.getElementById("wikibarButton"+t);var r=0,i=0;for(var s=0;s<n.addons.length;s++){var o=n.addons[s];if(o.ok){displayMessage("[ o ] "+o.name);r++}else{displayMessage("[ x ] "+o.name+": "+o.error);i++}}displayMessage("---------------------------------");displayMessage(r+" ok ; "+i+" failed")}function wikibar_getColorCode(e){var t=function(e,t){t.params=e;t.button.toolItem.doMore(t)};wikibarColorTool.openColorPicker(e.button,t,e)}function wikibar_getLinkUrl(e){var t=prompt("Please enter the link target",this.param?this.param:"");if(t&&t.trim().length>0){e.params=t;this.doMore(e)}}function wikibar_getTableRowCol(e){var t=prompt("Please enter (rows x cols) of the table","2 x 3");if(!t||t.trim().length<=0){return}var n=t.toUpperCase().split("X");if(n.length!=2){return}for(var r=0;r<n.length;r++){if(isNaN(n[r].trim())){return}}var i=parseInt(n[0].trim(),10);var s=parseInt(n[1].trim(),10);var o="";for(var u=0;u<i;u++){for(var a=0;a<=s;a++){if(a===0){o+="|"}else{o+=" |"}}o+="\n"}if(o.trim().length>0){e.params=o.trim();this.doMore(e)}}function wikibar_getMacroParam(e){var t=prompt('Please enter the parameters of macro "'+this.key+'":'+"\nSyntax: "+this.syntax+"\n\nNote: "+"\n%1,%2,... - parameter needed"+"\n[%1] - optional parameter"+"\n%N   - more than one parameter(1~n)"+"\n[%N] - any number of parameters(0~n)"+"\n\nPS:"+"\n1. Parameters should be seperated with space character"+'\n2. Use " to wrap the parameter that includes space character, ex: "hello world"'+"\n3. Input the word(null) for the optional parameter ignored",this.param?this.param:"");if(!t){return}t=t.readMacroParams();for(var n=0;n<t.length;n++){var r=t[n].trim();if(r.indexOf(" ")>0){t[n]="'"+r+"'"}if(r.toLowerCase()=="null"){t[n]=null}}e.params=t;this.doMore(e)}function wikibar_getMorePalette(e){clearMessage();displayMessage("Get more color palettes(*.gpl) from ColorZilla Palettes site","http://www.iosart.com/firefox/colorzilla/palettes.html");displayMessage('Save it as a new tiddler with "ColorPalettes" tag')}function wikibar_createWikibar(e){var t=document.getElementById("wikibar"+e);if(t){if(t.hasChildNodes()){t.style.display=t.style.display=="block"?"none":"block";return}}var n=document.getElementById("tiddler"+e);var r=wikibar_resolveTiddlerEditor(n);if(!r){clearMessage();displayMessage("WikiBar only works in tiddler edit mode now");return}else{if(!r.id){r.id="editor"+e}if(!r.parentNode.id){r.parentNode.id="editorWrapper"+e}}if(t){t=document.getElementById("wikibar"+e)}else{var i=wikibar_resolveTiddlerEditorWrapper(r);t=createTiddlyElement(n,"div","wikibar"+e,"toolbar");addClass(t,"wikibar");var s=document.getElementById("previewer"+e);if(s){n.insertBefore(t,s)}else{n.insertBefore(t,i)}}wikibar_createMenu(t,wikibarStore,e,r);if(config.options["chkWikibarSetEditorHeight"]&&config.options["txtWikibarEditorRows"]){r.rows=config.options["txtWikibarEditorRows"]}setStylesheet(".wikibar{text-align:left;visibility:visible;margin:2px;padding:1px;}.previewer{overflow:auto;display:block;border:1px solid;}#colorPicker{position:absolute;display:none;z-index:10;margin:0px;padding:0px;}#colorPicker table{margin:0px;padding:0px;border:2px solid #000;border-spacing:0px;border-collapse:collapse;}#colorPicker td{margin:0px;padding:0px;border:1px solid;font-size:11px;text-align:center;cursor:auto;}#colorPicker .header{background-color:#fff;}#colorPicker .button{background-color:#fff;cursor:pointer;cursor:hand;}#colorPicker .button:hover{padding-top:3px;padding-bottom:3px;color:#fff;background-color:#136;}#colorPicker .cell{padding:4px;font-size:7px;cursor:crosshair;}#colorPicker .cell:hover{padding:10px;}.wikibarPopup{position:absolute;z-index:10;border:1px solid #014;color:#014;background-color:#cef;}.wikibarPopup table{margin:0;padding:0;border:0;border-spacing:0;border-collapse:collapse;}.wikibarPopup .button:hover{color:#eee;background-color:#014;}.wikibarPopup .disabled{color:#888;}.wikibarPopup .disabled:hover{color:#888;background-color:#cef;}.wikibarPopup tr .seperator hr{margin:0;padding:0;background-color:#cef;width:100%;border:0;border-top:1px dashed #014;}.wikibarPopup tr .icon{font-family:verdana;font-weight:bolder;}.wikibarPopup tr .marker{font-family:verdana;font-weight:bolder;}.wikibarPopup td{font-size:0.9em;padding:2px;}.wikibarPopup input{border:0;border-bottom:1px solid #014;margin:0;padding:0;font-family:arial;font-size:100%;background-color:#fff;}","WikiBarStyleSheet")}function wikibar_createMenu(e,t,n,r){if(!wikibar_isValidMenuItem(t)){return}if(!(t.TYPE=="MAIN_MENU"||t.TYPE=="MENU")){return}for(var i in t){if(i.substring(0,9)=="SEPERATOR"){wikibar_createMenuSeperator(e);continue}if(i.substring(0,8)=="DYNAITEM"){var s=t[i](n,r);if(s.TYPE&&s.TYPE=="MENU"){wikibar_createMenuItem(e,s,null,r,n)}else{s.TYPE="MENU";wikibar_createMenu(e,s,n,r)}continue}if(t[i].TYPE!="MENU"&&t[i].TYPE!="MAIN_MENU"&&!t[i].HANDLER){continue}wikibar_createMenuItem(e,t,i,r,n)}}function wikibar_createMenuItem(e,t,n,r,i){if(!n){var s=t}else{s=t[n];s.key=n}if(!wikibar_isValidMenuItem(s)){return}var o=t.TYPE=="MAIN_MENU";var u=s.TYPE=="MENU";var a;if(o){a=createTiddlyButton(e,"",s.TOOLTIP?s.TOOLTIP:"",u?wikibar_onClickMenuItem:wikibar_onClickItem,"button");a.innerHTML=s.CAPTION?s.CAPTION:n;a.isOnMainMenu=true;addClass(a,u?"menu":"item");e.appendChild(document.createTextNode("\n"));if(!u){if(config.options["chkWikibarPopmenuOnMouseOver"]){a.onmouseover=function(e){wikibarPopup.remove()}}}}else{a=createTiddlyElement(e,"tr",n,"button");a.title=s.TOOLTIP?s.TOOLTIP:"";a.onclick=u?wikibar_onClickMenuItem:wikibar_onClickItem;var f=createTiddlyElement(a,"td","","marker");var l=createTiddlyElement(a,"td");var c=createTiddlyElement(a,"td","","marker");l.innerHTML=s.CAPTION?s.CAPTION:n;if(u){c.innerHTML="&nbsp;&nbsp;&rsaquo;"}if(s.SELECTED){f.innerHTML="&radic; ";addClass(a,"selected")}if(s.DISABLED){addClass(a,"disabled")}}a.tiddlerTitle=i;a.toolItem=s;a.editor=r;a.tabIndex=999;if(u){if(config.options["chkWikibarPopmenuOnMouseOver"]){a.onmouseover=wikibar_onClickMenuItem}}}function wikibar_createMenuSeperator(e){if(e.id.substring(0,7)=="wikibar"){return}var t=function(e){if(!e){e=window.event}e.cancelBubble=true;if(e.stopPropagation){e.stopPropagation()}return false};var n=createTiddlyElement(e,"tr","","seperator");var r=createTiddlyElement(n,"td","","seperator");r.colSpan=3;n.onclick=t;r.innerHTML="<hr>"}function wikibar_genWikibarAbout(){var e={};e.version={CAPTION:"<center>WikiBar "+config.macros.wikibar.major+"."+config.macros.wikibar.minor+"."+config.macros.wikibar.revision+(config.macros.wikibar.beta?" beta "+config.macros.wikibar.beta:"")+"</center>",HANDLER:function(){}};e.SEPERATOR={};e.author={CAPTION:"<center>Arphen Lin<br>arphenlin@gmail.com</center>",TOOLTIP:"send mail to the author",HANDLER:function(){window.open("mailto:arphenlin@gmail.com")}};e.website={CAPTION:"<center>aiddlywiki.sourceforge.net</center>",TOOLTIP:"go to the web site of WikiBar",HANDLER:function(){window.open("http://aiddlywiki.sourceforge.net/")}};return e}function wikibar_genWikibarOptions(e,t){var n={};n.popOnMouseOver={CAPTION:"popup menu on mouse over",SELECTED:config.options["chkWikibarPopmenuOnMouseOver"],HANDLER:function(e){config.options["chkWikibarPopmenuOnMouseOver"]=!config.options["chkWikibarPopmenuOnMouseOver"];saveOptionCookie("chkWikibarPopmenuOnMouseOver");var t=e.button.tiddlerTitle;var n=document.getElementById("wikibar"+t);if(n){n.parentNode.removeChild(n)}wikibar_createWikibar(t)}};n.setEditorSize={CAPTION:'set editor height: <input id="txtWikibarEditorRows" type=text size=1 MAXLENGTH=3 value="'+(config.options["txtWikibarEditorRows"]?config.options["txtWikibarEditorRows"]:t.rows)+'"> ok',HANDLER:function(e){var t=document.getElementById("txtWikibarEditorRows");if(t){var n=parseInt(t.value,10);if(!isNaN(n)){var r=e.button.editor;r.rows=n}else{n=config.maxEditRows}config.options["txtWikibarEditorRows"]=n;saveOptionCookie("txtWikibarEditorRows");config.maxEditRows=n}}};n.setEditorSizeOnLoadingWikibar={CAPTION:"set editor height on loading wikibar",SELECTED:config.options["chkWikibarSetEditorHeight"],HANDLER:function(e){config.options["chkWikibarSetEditorHeight"]=!config.options["chkWikibarSetEditorHeight"];saveOptionCookie("chkWikibarSetEditorHeight");if(config.options["chkWikibarSetEditorHeight"]){var t=config.options["txtWikibarEditorRows"];if(!isNaN(t)){t=15}var n=e.button.editor;n.rows=t;config.options["txtWikibarEditorRows"]=t;saveOptionCookie("txtWikibarEditorRows")}}};n.SEPERATOR={};n.update={CAPTION:"check for updates",DISABLED:true,HANDLER:function(){}};return n}function wikibar_genPaletteSelector(){try{var e=store.getTaggedTiddlers("ColorPalettes");if(!e){return}var t=[];t.push(wikibarColorTool.defaultPaletteName);for(var n=0;n<e.length;n++){t.push(e[n].title.trim())}var r={};for(n=0;n<t.length;n++){r[t[n]]={TOOLTIP:t[n],SELECTED:t[n]==wikibarColorTool.paletteName,HANDLER:wikibar_doSelectPalette}}return r}catch(i){return null}}function wikibar_onClickItem(e){if(!e){e=window.event}var t=resolveTarget(e);if(t.tagName=="INPUT"){e.cancelBubble=true;if(e.stopPropagation){e.stopPropagation()}return}var n=wikibar_resolveTargetButton(t);if(!n){return false}var r=n.toolItem;if(!r){return}var i={event:e,button:n};if(r.HANDLER){r.HANDLER(i)}if(r.DISABLED){e.cancelBubble=true;if(e.stopPropagation){e.stopPropagation()}}return false}function wikibar_onClickMenuItem(e){if(!e){e=window.event}var t=wikibar_resolveTargetButton(resolveTarget(e));if(!t){return false}e.cancelBubble=true;if(e.stopPropagation){e.stopPropagation()}var n=t.tiddlerTitle;var r=t.editor;var i=t.toolItem;if(!i){return}var s=wikibarPopup.create(this);if(s){wikibar_createMenu(s,i,n,r);if(!s.hasChildNodes()){wikibarPopup.remove()}else{wikibarPopup.show(s,false)}}return false}function wikibar_doSelectPalette(e){clearMessage();var t=e.button;if(!t.toolItem.key){return}var n=t.toolItem.key;var r=wikibarColorTool.paletteName;if(r!=n){try{wikibarColorTool.createColorPicker(t,n);displayMessage('Palette "'+n+'" ('+wikibarColorTool.palette.length+" colors) is selected")}catch(i){errMsg=i;if(errMsg.substring(0,18)=="renderColorPalette"){displayMessage('Invalid palette "'+n+'", please check it out!');wikibarColorTool.createColorPicker(t,r)}}}}config.macros.wikibar={major:3,minor:0,revision:0,date:new Date(2013,12,14)};config.macros.wikibar.handler=function(e,t,n,r,i,s){if(!(s instanceof Tiddler)){return}story.setDirty(s.title,true);e.id="wikibar"+s.title.replace(/_/g,"__").replace(/ /g,"_");e.className="toolbar wikibar"};var wikibarColorTool={defaultPaletteName:"default",defaultColumns:16,defaultPalette:["#FFF","#DDD","#CCC","#BBB","#AAA","#999","#666","#333","#111","#000","#FC0","#F90","#F60","#F30","#C30","#C03","#9C0","#9D0","#9E0","#E90","#D90","#C90","#FC3","#FC6","#F96","#F63","#600","#900","#C00","#F00","#F36","#F03","#CF0","#CF3","#330","#660","#990","#CC0","#FF0","#C93","#C63","#300","#933","#C33","#F33","#C36","#F69","#F06","#9F0","#CF6","#9C3","#663","#993","#CC3","#FF3","#960","#930","#633","#C66","#F66","#903","#C39","#F6C","#F09","#6F0","#9F6","#6C3","#690","#996","#CC6","#FF6","#963","#630","#966","#F99","#F39","#C06","#906","#F3C","#F0C","#3F0","#6F3","#390","#6C0","#9F3","#CC9","#FF9","#C96","#C60","#C99","#F9C","#C69","#936","#603","#C09","#303","#0C0","#3C0","#360","#693","#9C6","#CF9","#FFC","#FC9","#F93","#FCC","#C9C","#969","#939","#909","#636","#606","#060","#3C3","#6C6","#0F0","#3F3","#6F6","#9F9","#CFC","#9CF","#FCF","#F9F","#F6F","#F3F","#F0F","#C6C","#C3C","#030","#363","#090","#393","#696","#9C9","#CFF","#39F","#69C","#CCF","#C9F","#96C","#639","#306","#90C","#C0C","#0F3","#0C3","#063","#396","#6C9","#9FC","#9CC","#06C","#369","#99F","#99C","#93F","#60C","#609","#C3F","#C0F","#0F6","#3F6","#093","#0C6","#3F9","#9FF","#699","#036","#039","#66F","#66C","#669","#309","#93C","#C6F","#90F","#0F9","#6F9","#3C6","#096","#6FF","#6CC","#366","#069","#36C","#33F","#33C","#339","#336","#63C","#96F","#60F","#0FC","#6FC","#3C9","#3FF","#3CC","#399","#033","#39C","#69F","#00F","#00C","#009","#006","#003","#63F","#30F","#0C9","#3FC","#0FF","#0CC","#099","#066","#3CF","#6CF","#09C","#36F","#0CF","#09F","#06F","#03F","#03C","#30C"],colorPicker:null,pickColorHandler:null,userData:null};wikibarColorTool.paletteName=wikibarColorTool.defaultPaletteName;wikibarColorTool.columns=wikibarColorTool.defaultColumns;wikibarColorTool.palette=wikibarColorTool.defaultPalette;wikibarColorTool.onPickColor=function(e){if(!e){e=window.event}var t=resolveTarget(e);if(!t){return false}color=t.bgColor.toLowerCase();if(!color){return}wikibarColorTool.displayColorPicker(false);if(wikibarColorTool.pickColorHandler){wikibarColorTool.pickColorHandler(color,wikibarColorTool.userData)}return false};wikibarColorTool.onMouseOver=function(e){if(!e){e=window.event}var t=resolveTarget(e);if(!t){return false}if(!wikibarColorTool){return}color=t.bgColor.toUpperCase();if(!color){return}td=document.getElementById("colorPickerInfo");if(!td){return}td.bgColor=color;td.innerHTML='<span style="color:#000;">'+color+"</span>&nbsp;&nbsp;&nbsp;"+'<span style="color:#fff;">'+color+"</span>";e.cancelBubble=true;if(e.stopPropagation){e.stopPropagation()}return false};wikibarColorTool.openColorPicker=function(e,t,n){wikibarColorTool.skipClickDocumentEvent=true;wikibarColorTool.pickColorHandler=t;wikibarColorTool.userData=n;wikibarColorTool.moveColorPicker(e)};wikibarColorTool.convert3to6HexColor=function(e){e=e.trim();var t=/^\#(\d|[a-f])(\d|[a-f])(\d|[a-f])$/gi;return t.test(e)?e.replace(t,"#$1$1$2$2$3$3"):e};wikibarColorTool.numToHexColor=function(e){if(typeof e=="number"&&e>=0&&e<=255){s=e.toString(16).toLowerCase();return s.length==1?"0"+s:s}else{return null}};wikibarColorTool.renderColorPalette=function(){if(wikibarColorTool.paletteName==wikibarColorTool.defaultPaletteName){wikibarColorTool.palette=wikibarColorTool.defaultPalette;wikibarColorTool.columns=wikibarColorTool.defaultColumns;return}tiddlerText=store.getTiddlerText(wikibarColorTool.paletteName,"").trim();if(tiddlerText.length<=0){return}var e=tiddlerText.split("\n");var t=[];columns=wikibarColorTool.defaultColumns;var n=null;errCount=0;for(var r=0;r<e.length;r++){cpLine=e[r].trim();if(!cpLine||cpLine.length<=0||cpLine.charAt(0)=="#"){continue}if(cpLine.substring(0,8).toLowerCase()=="columns:"){n=cpLine.split(":");try{columns=parseInt(n[1],10)}catch(i){columns=wikibarColorTool.defaultColumns}}else{n=cpLine.replace("	"," ").split(/[ ]{1,}/);try{color="";for(var s=0;s<3;s++){c=parseInt(n[s].trim(),10);if(isNaN(c)){break}else{c=wikibarColorTool.numToHexColor(c);if(!c){break}color+=c}}if(color.length==6){t.push("#"+color)}else{throw"error"}}catch(i){}}}if(t.length>0){wikibarColorTool.palette=t;wikibarColorTool.columns=columns}else{throw"renderColorPalette(): No color defined in the palette."}};wikibarColorTool.displayColorPicker=function(e){if(wikibarColorTool.colorPicker){wikibarColorTool.colorPicker.style.display=e?"block":"none"}};wikibarColorTool.moveColorPicker=function(e){if(!wikibarColorTool.colorPicker){wikibarColorTool.createColorPicker()}var t=wikibarColorTool.colorPicker;var n=findPosX(e);var r=findPosY(e);var i=n;var s=r;var o=t.offsetWidth;var u=findWindowWidth();if(i+o>u){i=u-o}t.style.left=i+"px";t.style.top=s+"px";wikibarColorTool.displayColorPicker(true)};wikibarColorTool.createColorPicker=function(e,t){if(t){wikibarColorTool.paletteName=t}wikibarColorTool.renderColorPalette();wikibarColorTool.colorPicker=document.createElement("div");wikibarColorTool.colorPicker.id="colorPicker";document.body.appendChild(wikibarColorTool.colorPicker);var n=document.createElement("table");wikibarColorTool.colorPicker.appendChild(n);var r=document.createElement("tr");n.appendChild(r);var i=document.createElement("td");i.className="header";i.colSpan=wikibarColorTool.columns;i.innerHTML=wikibarColorTool.paletteName;r.appendChild(i);for(var s=0;s<wikibarColorTool.palette.length;s++){if(s%wikibarColorTool.columns===0){r=document.createElement("tr");n.appendChild(r)}i=document.createElement("td");i.className="cell";i.bgColor=wikibarColorTool.convert3to6HexColor(wikibarColorTool.palette[s]);i.onclick=wikibarColorTool.onPickColor;i.onmouseover=wikibarColorTool.onMouseOver;r.appendChild(i)}rest=wikibarColorTool.palette.length%wikibarColorTool.columns;if(rest>0){i=document.createElement("td");i.colSpan=wikibarColorTool.columns-rest;i.bgColor="#000000";r.appendChild(i)}r=document.createElement("tr");n.appendChild(r);i=document.createElement("td");i.colSpan=wikibarColorTool.columns;i.id="colorPickerInfo";r.appendChild(i)};wikibarColorTool.onDocumentClick=function(e){if(!e){e=window.event}if(wikibarColorTool.skipClickDocumentEvent){wikibarColorTool.skipClickDocumentEvent=false;return true}if(!e.eventPhase||e.eventPhase==Event.BUBBLING_PHASE||e.eventPhase==Event.AT_TARGET){wikibarColorTool.displayColorPicker(false)}return true};var wikibarPopup={skipClickDocumentEvent:false,stack:[]};wikibarPopup.resolveRootPopup=function(e){if(e.isOnMainMenu){return null}if(e.className.substring(0,12)=="wikibarPopup"){return e}return wikibarPopup.resolveRootPopup(e.parentNode)};wikibarPopup.create=function(e){for(var t=0;t<wikibarPopup.stack.length;t++){var n=wikibarPopup.stack[t];if(n.root==e){wikibarPopup.removeFrom(t+1);return null}}var r=wikibarPopup.resolveRootPopup(e);if(!r){wikibarPopup.remove()}else{wikibarPopup.removeFromRootPopup(r)}var i=createTiddlyElement(document.body,"div","wikibarPopup"+e.toolItem.key,"wikibarPopup");var s=createTiddlyElement(i,"table","","");wikibarPopup.stack.push({rootPopup:r,root:e,popup:i});return s};wikibarPopup.show=function(e,t){var n=wikibarPopup.stack[wikibarPopup.stack.length-1];var r=1;var i,s,o,u,a,f,l;if(n.rootPopup){i=findPosX(n.rootPopup);s=findPosY(n.root);o=n.rootPopup.offsetWidth;a=i+o-r;f=s}else{i=findPosX(n.root);s=findPosY(n.root);u=n.root.offsetHeight;a=i;f=s+u}var c=findWindowWidth();l=n.popup.offsetWidth;if(a+l>c){a=i-l+r}n.popup.style.left=a+"px";n.popup.style.top=f+"px";n.popup.style.display="block";addClass(n.root,"highlight");if(config.options.chkAnimate){anim.startAnimating(new Scroller(n.popup,t))}else{window.scrollTo(0,ensureVisible(n.popup))}};wikibarPopup.remove=function(){if(wikibarPopup.stack.length>0){wikibarPopup.removeFrom(0)}};wikibarPopup.removeFrom=function(e){for(var t=wikibarPopup.stack.length-1;t>=e;t--){var n=wikibarPopup.stack[t];removeClass(n.root,"highlight");n.popup.parentNode.removeChild(n.popup)}wikibarPopup.stack=wikibarPopup.stack.slice(0,e)};wikibarPopup.removeFromRootPopup=function(e){for(var t=0;t<wikibarPopup.stack.length;t++){var n=wikibarPopup.stack[t];if(n.rootPopup==e){wikibarPopup.removeFrom(t);break}}};wikibarPopup.onDocumentClick=function(e){if(!e){e=window.event}if(wikibarPopup.skipClickDocumentEvent){wikibarPopup.skipClickDocumentEvent=false;return true}if(!e.eventPhase||e.eventPhase==Event.BUBBLING_PHASE||e.eventPhase==Event.AT_TARGET){wikibarPopup.remove()}return true};var wikibarStore={TYPE:"MAIN_MENU",help:{TYPE:"MENU",CAPTION:'<font face="verdana">?</font>',TOOLTIP:"about WikiBar",options:{TYPE:"MENU",DYNAITEM:wikibar_genWikibarOptions},about:{TYPE:"MENU",DYNAITEM:wikibar_genWikibarAbout}},preview:{TOOLTIP:"preview this tiddler",CAPTION:'<font face="verdana">&infin;</font>',HANDLER:wikibar_doPreview},line:{TOOLTIP:"<hr>",CAPTION:'<font face="verdana">&mdash;</font>',syntax:"\n----\n",HANDLER:wikibar_editFormatByCursor},crlf:{TOOLTIP:"new line",CAPTION:'<font face="verdana">&para;</font>',syntax:"\n",HANDLER:wikibar_editFormatByCursor},selectAll:{TOOLTIP:"select all",CAPTION:'<font face="verdana">&sect;</font>',HANDLER:wikibar_editSelectAll},deleteSelected:{TOOLTIP:"delete selected",CAPTION:'<font face="verdana">&times;</font>',syntax:"",HANDLER:wikibar_editFormat},textFormat:{TYPE:"MENU",CAPTION:"text",TOOLTIP:"text formatters",ignore:{TOOLTIP:"ignore wiki word",CAPTION:"ignore wikiWord",syntax:"~user_text",hint:"wiki_word",HANDLER:wikibar_editFormatByWord},bolder:{TOOLTIP:"Текст жирным",CAPTION:"<strong>жирно</strong>",syntax:"++user_text++",hint:"bold_text",HANDLER:wikibar_editFormatByWord},italic:{TOOLTIP:"Текст курсивом",CAPTION:"<em>курсив</em>",syntax:"//user_text//",hint:"italic_text",HANDLER:wikibar_editFormatByWord},underline:{TOOLTIP:"underline text",CAPTION:"<u>подчеркнуто</u>",syntax:"__user_text__",hint:"underline_text",HANDLER:wikibar_editFormatByWord},strikethrough:{TOOLTIP:"strikethrough text",CAPTION:"<strike>зачеркнуто</strike>",syntax:"==user_text==",hint:"strikethrough_text",HANDLER:wikibar_editFormatByWord},superscript:{TOOLTIP:"superscript text",CAPTION:"X<sup>верхний индекс</sup>",syntax:"^^user_text^^",hint:"superscript_text",HANDLER:wikibar_editFormatByWord},subscript:{TOOLTIP:"subscript text",CAPTION:"X<sub>нижний индекс</sub>",syntax:"~~user_text~~",hint:"subscript_text",HANDLER:wikibar_editFormatByWord},comment:{TOOLTIP:"comment text",CAPTION:"комментарий",syntax:"/%user_text%/",hint:"comment_text",HANDLER:wikibar_editFormatByWord},monospaced:{TOOLTIP:"monospaced text",CAPTION:"<code>моноширинный</code>",syntax:"{{{user_text}}}",hint:"monospaced_text",HANDLER:wikibar_editFormatByWord}},paragraph:{TYPE:"MENU",TOOLTIP:"форматирование абзацев",list:{TYPE:"MENU",TOOLTIP:"list tools",bullet:{TOOLTIP:"bullet point",syntax:"*user_text",hint:"bullet_text",HANDLER:wikibar_editFormatByLine},numbered:{TOOLTIP:"numbered list",syntax:"#user_text",hint:"numbered_text",HANDLER:wikibar_editFormatByLine}},heading:{TYPE:"MENU",heading1:{CAPTION:"<h1>Heading 1</h1>",TOOLTIP:"Heading 1",syntax:"!user_text",hint:"heading_1",HANDLER:wikibar_editFormatByLine},heading2:{CAPTION:"<h2>Heading 2<h2>",TOOLTIP:"Heading 2",syntax:"!!user_text",hint:"heading_2",HANDLER:wikibar_editFormatByLine},heading3:{CAPTION:"<h3>Heading 3</h3>",TOOLTIP:"Heading 3",syntax:"!!!user_text",hint:"heading_3",HANDLER:wikibar_editFormatByLine},heading4:{CAPTION:"<h4>Heading 4</h4>",TOOLTIP:"Heading 4",syntax:"!!!!user_text",hint:"heading_4",HANDLER:wikibar_editFormatByLine},heading5:{CAPTION:"<h5>Heading 5</h5>",TOOLTIP:"Heading 5",syntax:"!!!!!user_text",hint:"heading_5",HANDLER:wikibar_editFormatByLine}},comment:{TYPE:"MENU",commentByLine:{CAPTION:"comment by line",TOOLTIP:"line comment",syntax:"/%user_text%/",hint:"comment_text",HANDLER:wikibar_editFormatByLine},commentByBlock:{CAPTION:"comment by block",TOOLTIP:"block comment",syntax:"/%\nuser_text\n%/",hint:"comment_text",byBlock:true,HANDLER:wikibar_editFormatByLine}},monospaced:{TYPE:"MENU",monosByLine:{CAPTION:"monospaced by line",TOOLTIP:"line monospaced",syntax:"{{{\nuser_text\n}}}",hint:"monospaced_text",HANDLER:wikibar_editFormatByLine},monosByBlock:{CAPTION:"monospaced by block",TOOLTIP:"block monospaced",syntax:"{{{\nuser_text\n}}}",hint:"monospaced_text",byBlock:true,HANDLER:wikibar_editFormatByLine}},quote:{TYPE:"MENU",quoteByLine:{CAPTION:"quote by line",TOOLTIP:"line quote",syntax:">user_text",hint:"quote_text",HANDLER:wikibar_editFormatByLine},quoteByBlcok:{CAPTION:"quote by block",TOOLTIP:"block quote",syntax:"<<<\nuser_text\n<<<",hint:"quote_text",byBlock:true,HANDLER:wikibar_editFormatByLine}},plugin:{TYPE:"MENU",code:{CAPTION:"code area",TOOLTIP:"block monospaced for plugin",syntax:"\n//{{{\nuser_text\n//}}}\n",hint:"monospaced_plugin_code",byBlock:true,HANDLER:wikibar_editFormatByLine},commentByLine:{CAPTION:"comment by line",TOOLTIP:"line comment",syntax:"//user_text",hint:"plugin_comment",HANDLER:wikibar_editFormatByLine},commentByBlock:{CAPTION:"comment by block",TOOLTIP:"block comment",syntax:"/***\nuser_text\n***/",hint:"plugin_comment",byBlock:true,HANDLER:wikibar_editFormatByLine}},css:{TYPE:"MENU",code:{CAPTION:"code area",TOOLTIP:"block monospaced for css",syntax:"\n\nuser_text\n\n",hint:"monospaced_css_code",byBlock:true,HANDLER:wikibar_editFormatByLine},commentByLine:{CAPTION:"comment by line",TOOLTIP:"line comment",syntax:"",hint:"css_comment",HANDLER:wikibar_editFormatByLine},commentByBlock:{CAPTION:"comment by block",TOOLTIP:"block comment",syntax:"",hint:"css_comment",byBlock:true,HANDLER:wikibar_editFormatByLine}}},color:{TYPE:"MENU",TOOLTIP:"color tools",highlight:{CAPTION:"highlight text",TOOLTIP:"highlight text",syntax:"@@user_text@@",hint:"highlight_text",HANDLER:wikibar_editFormatByWord},color:{CAPTION:"text color",TOOLTIP:"text color",hint:"your_text",syntax:"@@color(%1):user_text@@",HANDLER:wikibar_getColorCode,doMore:wikibar_editFormatByWord},bgcolor:{CAPTION:"background color",TOOLTIP:"background color",hint:"your_text",syntax:"@@bgcolor(%1):user_text@@",HANDLER:wikibar_getColorCode,doMore:wikibar_editFormatByWord},colorcode:{CAPTION:"color code",TOOLTIP:"insert color code",syntax:"%1",HANDLER:wikibar_getColorCode,doMore:wikibar_editFormatByCursor},"color palette":{TYPE:"MENU",DYNAITEM:wikibar_genPaletteSelector,SEPERATOR:{},morePalette:{CAPTION:"more palettes",TOOLTIP:"get more palettes",HANDLER:wikibar_getMorePalette}}},link:{TYPE:"MENU",TOOLTIP:"insert link",wiki:{CAPTION:"wiki link",TOOLTIP:"wiki link",syntax:"[[user_text]]",hint:"wiki_word",HANDLER:wikibar_editFormatByWord},pretty:{CAPTION:"pretty link",TOOLTIP:"pretty link",syntax:"[[user_text|%1]]",hint:"pretty_word",param:"PrettyLink Target",HANDLER:wikibar_getLinkUrl,doMore:wikibar_editFormatByWord},url:{TOOLTIP:"url link",syntax:"[[user_text|%1]]",hint:"your_text",param:"http://...",HANDLER:wikibar_getLinkUrl,doMore:wikibar_editFormatByWord},image:{TOOLTIP:"image link",syntax:"[img[user_text|%1]]",hint:"alt_text",param:"image/icon.jpg",HANDLER:wikibar_getLinkUrl,doMore:wikibar_editFormatByWord}},macro:{},more:{TYPE:"MENU",TOOLTIP:"more tools",table:{TYPE:"MENU",TOOLTIP:"table",table:{CAPTION:"create table",TOOLTIP:"create a new table",syntax:"\n%1\n",HANDLER:wikibar_getTableRowCol,doMore:wikibar_editFormatByWord},header:{TOOLTIP:"table header text",syntax:"|user_text|c",hint:"table_header",HANDLER:wikibar_editFormatByWord},cell:{TOOLTIP:"create a tabel cell",syntax:"|user_text|",hint:"your_text",HANDLER:wikibar_editFormatByWord},columnHeader:{CAPTION:"column header",TOOLTIP:"create a column header cell",syntax:"|!user_text|",hint:"column_header",HANDLER:wikibar_editFormatByWord},cell:{TYPE:"MENU",CAPTION:"cell options",bgcolor:{CAPTION:"background color",TOOLTIP:"cell bgcolor",syntax:"|bgcolor(%1):user_text|",hint:"your_text",HANDLER:wikibar_getColorCode,doMore:wikibar_editFormatByTableCell},alignLeft:{CAPTION:"align left",TOOLTIP:"left align cell text",syntax:"|user_text|",hint:"your_text",HANDLER:wikibar_editFormatByTableCell},alignCenter:{CAPTION:"align center",TOOLTIP:"center align cell text",syntax:"| user_text |",hint:"your_text",HANDLER:wikibar_editFormatByTableCell},alignRight:{CAPTION:"align right",TOOLTIP:"right align cell text",syntax:"| user_text|",hint:"your_text",HANDLER:wikibar_editFormatByTableCell}}},html:{TYPE:"MENU",html:{CAPTION:"&lt;html&gt;",TOOLTIP:"html tag",syntax:"<html>\nuser_text\n</html>",hint:"html_content",byBlock:true,HANDLER:wikibar_editFormatByLine}}},addon:{TYPE:"MENU",TOOLTIP:"3rd party tools","about addons":{TOOLTIP:"list loaded addons",HANDLER:wikibar_doListAddons},SEPERATOR:{}}};addEvent(document,"click",wikibarColorTool.onDocumentClick);addEvent(document,"click",wikibarPopup.onDocumentClick);wikibar_install()